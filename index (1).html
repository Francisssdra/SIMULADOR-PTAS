<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Digital - Planta de Tratamiento de Aguas Servidas RTB/SALFA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #0a0e27;
            --primary-lighter: #1a1f3a;
            --accent-cyan: #00d4ff;
            --accent-orange: #ff8c00;
            --accent-green: #00ff41;
            --accent-red: #ff3333;
            --accent-amber: #ffa500;
            --text-light: #e0e6ff;
            --tank-green: #2d5016;
            --tank-outline: #1a3009;
            --water-blue: #0066cc;
        }

        body {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #0f1433 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            background: rgba(10, 14, 39, 0.95);
            border-bottom: 2px solid var(--accent-cyan);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-section h1 {
            font-size: 1.8rem;
            color: var(--accent-cyan);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            margin-bottom: 0.3rem;
        }

        .title-section p {
            font-size: 0.9rem;
            color: var(--accent-green);
        }

        .status-badge {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .status-badge .pulse {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse-animation 1.5s ease-in-out infinite;
        }

        @keyframes pulse-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* CONTENEDOR PRINCIPAL */
        .main-container {
            max-width: 1600px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 250px 1fr 280px;
            gap: 1.5rem;
        }

        /* PANEL LATERAL IZQUIERDO - CONFIGURACI√ìN */
        .control-panel {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
            position: sticky;
            top: 20px;
        }

        .control-panel h3 {
            color: var(--accent-cyan);
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--accent-cyan);
            padding-bottom: 0.5rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 0.6rem;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, select:focus,
        input[type="range"]:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-orange);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
            outline: none;
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--accent-orange);
            margin-top: 0.3rem;
            font-weight: bold;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.8rem;
        }

        button {
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            color: var(--primary-dark);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 255, 65, 0.4);
        }

        button:active {
            transform: translateY(-1px);
        }

        button.stop {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-amber));
        }

        /* CANVAS CENTRAL - VISUALIZACI√ìN DE PLANTA */
        .visualization-container {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }

        .canvas-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(10, 14, 39, 0.5);
            border-radius: 10px;
            padding: 1rem;
            border: 1px dashed rgba(0, 212, 255, 0.1);
        }

        canvas {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* PANEL LATERAL DERECHO - RESULTADOS */
        .results-panel {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
            position: sticky;
            top: 20px;
        }

        .results-panel h3 {
            color: var(--accent-cyan);
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--accent-cyan);
            padding-bottom: 0.5rem;
        }

        .gauge-item {
            margin-bottom: 1.5rem;
            background: rgba(0, 212, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
            border-left: 3px solid var(--accent-green);
        }

        .gauge-label {
            font-size: 0.85rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .gauge-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-green);
            margin-bottom: 0.3rem;
        }

        .gauge-unit {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .gauge-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .alert-warning {
            color: var(--accent-red);
            font-weight: bold;
        }

        .alert-success {
            color: var(--accent-green);
        }

        .state-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse-animation 1s ease-in-out infinite;
        }

        .state-indicator.aerating {
            background: var(--accent-green);
        }

        .state-indicator.resting {
            background: var(--accent-amber);
            animation: pulse-animation 0.5s ease-in-out infinite;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .control-panel,
            .results-panel {
                position: relative;
                top: 0;
            }

            .visualization-container {
                order: -1;
            }
        }

        /* ANIMACIONES DE AGUA */
        @keyframes flow {
            0% {
                stroke-dashoffset: 100;
            }
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes bubble-rise {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-60px) translateX(5px);
                opacity: 0;
            }
        }

        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 212, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }

        /* NORMATIVAS BADGE */
        .compliance-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 0.3px;
        }

        .compliance-badge.pass {
            background: rgba(0, 255, 65, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .compliance-badge.fail {
            background: rgba(255, 51, 51, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-content">
            <div class="title-section">
                <h1>‚öôÔ∏è Gemelo Digital - RTB/SALFA</h1>
                <p>Simulador de Planta de Tratamiento de Aguas Servidas</p>
            </div>
            <div class="status-badge">
                <div class="pulse"></div>
                <span>Sistema Online</span>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="main-container">
        <!-- PANEL CONTROL IZQUIERDO -->
        <div class="control-panel">
            <h3>üéõÔ∏è Configuraci√≥n</h3>

            <div class="control-group">
                <label for="plantSelect">Modelo de Planta</label>
                <select id="plantSelect">
                    <option value="20">RTB20 (20m¬≥)</option>
                    <option value="30" selected>RTB30 (30m¬≥)</option>
                    <option value="40">RTB40 (40m¬≥)</option>
                    <option value="60">RTB60 (60m¬≥)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="caudal">Caudal Entrada (m¬≥/d√≠a)</label>
                <input type="range" id="caudal" min="1" max="80" value="15" step="1">
                <div class="slider-value">
                    <span>Min: 1</span>
                    <span id="caudal-value">15 m¬≥/d√≠a</span>
                    <span>Max: 80</span>
                </div>
            </div>

            <div class="control-group">
                <label for="dbo5Input">DBO‚ÇÖ Entrada (mg/L)</label>
                <input type="range" id="dbo5Input" min="50" max="1000" value="200" step="10">
                <div class="slider-value">
                    <span>Min: 50</span>
                    <span id="dbo5Input-value">200 mg/L</span>
                    <span>Max: 1000</span>
                </div>
            </div>

            <div class="control-group">
                <label for="dqoInput">DQO Entrada (mg/L)</label>
                <input type="range" id="dqoInput" min="100" max="2000" value="400" step="20">
                <div class="slider-value">
                    <span>Min: 100</span>
                    <span id="dqoInput-value">400 mg/L</span>
                    <span>Max: 2000</span>
                </div>
            </div>

            <h3 style="margin-top: 1.5rem;">‚è±Ô∏è Ciclo Aeraci√≥n</h3>

            <div class="control-group">
                <label for="timeOn">Tiempo ON (minutos)</label>
                <input type="range" id="timeOn" min="1" max="60" value="30" step="1">
                <div class="slider-value">
                    <span id="timeOn-value">30 min</span>
                </div>
            </div>

            <div class="control-group">
                <label for="timeOff">Tiempo OFF (minutos)</label>
                <input type="range" id="timeOff" min="0" max="30" value="10" step="1">
                <div class="slider-value">
                    <span id="timeOff-value">10 min</span>
                </div>
            </div>

            <div class="button-group">
                <button id="startBtn">‚ñ∂ Iniciar Simulaci√≥n</button>
                <button id="stopBtn" class="stop" style="display:none;">‚èπ Detener</button>
                <button id="resetBtn">üîÑ Reiniciar</button>
            </div>
        </div>

        <!-- CANVAS CENTRAL -->
        <div class="visualization-container">
            <div class="canvas-wrapper">
                <canvas id="plantCanvas" width="900" height="450"></canvas>
            </div>
        </div>

        <!-- PANEL RESULTADOS DERECHA -->
        <div class="results-panel">
            <h3>üìä Resultados</h3>

            <div class="gauge-item">
                <div class="gauge-label">DBO‚ÇÖ Salida</div>
                <div class="gauge-value" id="dbo5Output">0</div>
                <div class="gauge-unit">mg/L</div>
                <div class="gauge-bar">
                    <div class="gauge-fill" id="dbo5Fill" style="width: 0%"></div>
                </div>
                <div id="dbo5Status"></div>
            </div>

            <div class="gauge-item">
                <div class="gauge-label">DQO Salida</div>
                <div class="gauge-value" id="dqoOutput">0</div>
                <div class="gauge-unit">mg/L</div>
                <div class="gauge-bar">
                    <div class="gauge-fill" id="dqoFill" style="width: 0%"></div>
                </div>
                <div id="dqoStatus"></div>
            </div>

            <div class="gauge-item">
                <div class="gauge-label">Eficiencia Global</div>
                <div class="gauge-value" id="efficiency">0<span style="font-size: 1rem;">%</span></div>
                <div class="gauge-bar">
                    <div class="gauge-fill" id="efficiencyFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="gauge-item">
                <div class="gauge-label">Estado Reactor</div>
                <div style="margin-top: 0.5rem;">
                    <span id="stateIndicator" class="state-indicator resting"></span>
                    <span id="stateText" style="color: var(--accent-amber);">En Reposo (An√≥xico)</span>
                </div>
                <div id="cycleInfo" style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;"></div>
            </div>

            <div class="gauge-item">
                <div class="gauge-label">Carga Volum√©trica</div>
                <div class="gauge-value" id="volumetricLoad">0</div>
                <div class="gauge-unit">m¬≥/m¬≥¬∑d√≠a</div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURACI√ìN Y ESTADO GLOBAL ==========
        const state = {
            plant: 30,
            caudal: 15,
            dbo5Input: 200,
            dqoInput: 400,
            timeOn: 30,
            timeOff: 10,
            isRunning: false,
            isAerating: false,
            currentTime: 0,
            cycleTime: 0,
            dbo5Output: 0,
            dqoOutput: 0,
            efficiency: 0,
            volumetricLoad: 0,
            tanks: [],
            aerationK: 0.15,  // Constante de degradaci√≥n con aireaci√≥n
            restingK: 0.03    // Constante de degradaci√≥n sin aireaci√≥n
        };

        // ========== CONFIGURACI√ìN DE TANQUES POR MODELO ==========
        const plantConfigs = {
            20: { 
                capacity: 20, 
                tanks: [
                    { type: 'accumulation', count: 1, volume: 5 },
                    { type: 'reactor', count: 2, volume: 7.5 },
                    { type: 'clarifier', count: 1, volume: 2.5 }
                ]
            },
            30: { 
                capacity: 30, 
                tanks: [
                    { type: 'accumulation', count: 1, volume: 7 },
                    { type: 'reactor', count: 3, volume: 10 },
                    { type: 'clarifier', count: 1, volume: 3 }
                ]
            },
            40: { 
                capacity: 40, 
                tanks: [
                    { type: 'accumulation', count: 1, volume: 8 },
                    { type: 'reactor', count: 4, volume: 12 },
                    { type: 'clarifier', count: 1, volume: 4 }
                ]
            },
            60: { 
                capacity: 60, 
                tanks: [
                    { type: 'accumulation', count: 1, volume: 10 },
                    { type: 'reactor', count: 4, volume: 15 },
                    { type: 'clarifier', count: 1, volume: 5 }
                ]
            }
        };

        // ========== ELEMENTOS DEL DOM ==========
        const elements = {
            plantSelect: document.getElementById('plantSelect'),
            caudal: document.getElementById('caudal'),
            dbo5Input: document.getElementById('dbo5Input'),
            dqoInput: document.getElementById('dqoInput'),
            timeOn: document.getElementById('timeOn'),
            timeOff: document.getElementById('timeOff'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            resetBtn: document.getElementById('resetBtn'),
            canvas: document.getElementById('plantCanvas'),
            dbo5Output: document.getElementById('dbo5Output'),
            dqoOutput: document.getElementById('dqoOutput'),
            efficiency: document.getElementById('efficiency'),
            stateIndicator: document.getElementById('stateIndicator'),
            stateText: document.getElementById('stateText'),
            cycleInfo: document.getElementById('cycleInfo'),
            volumetricLoad: document.getElementById('volumetricLoad'),
            dbo5Status: document.getElementById('dbo5Status'),
            dqoStatus: document.getElementById('dqoStatus')
        };

        const ctx = elements.canvas.getContext('2d');

        // ========== ACTUALIZACI√ìN DE VALORES EN SLIDERS ==========
        elements.caudal.addEventListener('input', (e) => {
            state.caudal = parseFloat(e.target.value);
            document.getElementById('caudal-value').textContent = state.caudal + ' m¬≥/d√≠a';
            updateSimulation();
        });

        elements.dbo5Input.addEventListener('input', (e) => {
            state.dbo5Input = parseFloat(e.target.value);
            document.getElementById('dbo5Input-value').textContent = state.dbo5Input + ' mg/L';
            updateSimulation();
        });

        elements.dqoInput.addEventListener('input', (e) => {
            state.dqoInput = parseFloat(e.target.value);
            document.getElementById('dqoInput-value').textContent = state.dqoInput + ' mg/L';
            updateSimulation();
        });

        elements.timeOn.addEventListener('input', (e) => {
            state.timeOn = parseFloat(e.target.value);
            document.getElementById('timeOn-value').textContent = state.timeOn + ' min';
            if (!state.isRunning) resetSimulation();
        });

        elements.timeOff.addEventListener('input', (e) => {
            state.timeOff = parseFloat(e.target.value);
            document.getElementById('timeOff-value').textContent = state.timeOff + ' min';
            if (!state.isRunning) resetSimulation();
        });

        elements.plantSelect.addEventListener('change', (e) => {
            state.plant = parseInt(e.target.value);
            updateTankConfig();
            if (!state.isRunning) resetSimulation();
        });

        // ========== L√ìGICA DE SIMULACI√ìN ==========
        function updateTankConfig() {
            const config = plantConfigs[state.plant];
            state.tanks = [];

            let xOffset = 50;
            const tankSpacing = 120;
            const tankHeight = 80;

            // Acumulaci√≥n
            for (let i = 0; i < config.tanks[0].count; i++) {
                state.tanks.push({
                    type: 'accumulation',
                    x: xOffset,
                    y: 150,
                    width: 80,
                    height: tankHeight,
                    volume: config.tanks[0].volume
                });
                xOffset += tankSpacing;
            }

            // Reactores (con aireadores)
            for (let i = 0; i < config.tanks[1].count; i++) {
                state.tanks.push({
                    type: 'reactor',
                    x: xOffset,
                    y: 150,
                    width: 80,
                    height: tankHeight,
                    volume: config.tanks[1].volume / config.tanks[1].count
                });
                xOffset += tankSpacing;
            }

            // Clarificador
            state.tanks.push({
                type: 'clarifier',
                x: xOffset,
                y: 160,
                width: 70,
                height: 60,
                volume: config.tanks[2].volume
            });
        }

        function calculateRemovalEfficiency() {
            // Tiempo de retenci√≥n hidr√°ulica (TRH)
            const reactorVolume = plantConfigs[state.plant].tanks[1].volume;
            const trh = reactorVolume / (state.caudal / 24); // en horas

            // Sobrecarga: si caudal > capacidad * 1.5, eficiencia baja dr√°sticamente
            const overloadFactor = state.caudal > state.plant * 1.5 ? 0.3 : 1.0;

            // Constante de degradaci√≥n: depende de aireaci√≥n
            const k = state.isAerating ? state.aerationK : state.restingK;

            // Modelo de primer orden: C_out = C_in * e^(-k*t)
            const timeConstant = trh / 60; // convertir a minutos para la exponencial
            const removalFactor = Math.exp(-k * timeConstant * overloadFactor);

            return 1 - removalFactor;
        }

        function updateSimulation() {
            if (!state.isRunning) {
                // Modo est√°tico: calcular sin ciclo
                const efficiency = calculateRemovalEfficiency();
                state.dbo5Output = Math.max(0, state.dbo5Input * (1 - efficiency));
                state.dqoOutput = Math.max(0, state.dqoInput * (1 - efficiency));
                state.efficiency = efficiency * 100;
            }

            // Carga volum√©trica (kg DBO5/m¬≥¬∑d√≠a)
            state.volumetricLoad = (state.caudal * state.dbo5Input) / (1000 * state.plant);

            updateUI();
            drawPlant();
        }

        function updateUI() {
            // Actualizar valores de salida
            elements.dbo5Output.textContent = Math.round(state.dbo5Output * 10) / 10;
            elements.dqoOutput.textContent = Math.round(state.dqoOutput * 10) / 10;
            elements.efficiency.innerHTML = Math.round(state.efficiency) + '<span style="font-size: 1rem;">%</span>';
            elements.volumetricLoad.textContent = state.volumetricLoad.toFixed(2);

            // Actualizar barras de progreso
            const maxDBO5 = 100;
            const maxDQO = 150;
            document.getElementById('dbo5Fill').style.width = (state.dbo5Output / maxDBO5 * 100) + '%';
            document.getElementById('dqoFill').style.width = (state.dqoOutput / maxDQO * 100) + '%';
            document.getElementById('efficiencyFill').style.width = state.efficiency + '%';

            // Normativa: DBO5 < 35 mg/L, DQO < 75 mg/L
            const dbo5Pass = state.dbo5Output <= 35;
            const dqoPass = state.dqoOutput <= 75;

            const dbo5Badge = dbo5Pass 
                ? '<div class="compliance-badge pass">‚úì Normativa OK</div>' 
                : '<div class="compliance-badge fail">‚úó Excede L√≠mite</div>';
            const dqoBadge = dqoPass 
                ? '<div class="compliance-badge pass">‚úì Normativa OK</div>' 
                : '<div class="compliance-badge fail">‚úó Excede L√≠mite</div>';

            elements.dbo5Status.innerHTML = dbo5Badge;
            elements.dqoStatus.innerHTML = dqoBadge;

            // Estado del reactor
            if (state.isAerating) {
                elements.stateIndicator.className = 'state-indicator aerating';
                elements.stateText.textContent = 'Aireando (Aer√≥bico)';
                elements.stateText.style.color = 'var(--accent-green)';
            } else {
                elements.stateIndicator.className = 'state-indicator resting';
                elements.stateText.textContent = 'En Reposo (An√≥xico)';
                elements.stateText.style.color = 'var(--accent-amber)';
            }

            // Informaci√≥n del ciclo
            if (state.isRunning) {
                const totalCycle = state.timeOn + state.timeOff;
                const cycleProgress = ((state.cycleTime % totalCycle) / totalCycle * 100).toFixed(0);
                const timeRemaining = state.isAerating 
                    ? (state.timeOn - (state.cycleTime % state.timeOn)).toFixed(1)
                    : (state.timeOff - ((state.cycleTime - state.timeOn) % state.timeOff)).toFixed(1);
                elements.cycleInfo.textContent = `Ciclo: ${cycleProgress}% | ${timeRemaining} min`;
            }
        }

        // ========== DIBUJO DE LA PLANTA EN CANVAS ==========
        function drawPlant() {
            // Limpiar canvas
            ctx.fillStyle = 'rgba(10, 14, 39, 0.5)';
            ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);

            // Dibujar tuber√≠as de conexi√≥n
            drawPipelines();

            // Dibujar tanques
            state.tanks.forEach((tank, index) => {
                drawTank(tank);

                // Dibujar aireadores sobre reactores
                if (tank.type === 'reactor' && state.isAerating) {
                    drawAerator(tank);
                    drawBubbles(tank, index);
                }
            });

            // Dibujar flujo de agua
            drawFlowIndicators();

            // Etiquetas
            drawLabels();
        }

        function drawTank(tank) {
            const x = tank.x;
            const y = tank.y;
            const w = tank.width;
            const h = tank.height;

            // Color seg√∫n tipo de tanque
            let fillColor = 'var(--tank-green)';
            let outlineColor = 'var(--tank-outline)';

            switch (tank.type) {
                case 'accumulation':
                    fillColor = '#1a4d2e';
                    break;
                case 'reactor':
                    fillColor = '#2d5016';
                    break;
                case 'clarifier':
                    fillColor = '#0d3b66';
                    break;
            }

            // Cuerpo del tanque (rect√°ngulo redondeado)
            ctx.fillStyle = fillColor;
            ctx.strokeStyle = outlineColor;
            ctx.lineWidth = 2;

            // Rect√°ngulo redondeado
            const radius = 10;
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + w - radius, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
            ctx.lineTo(x + w, y + h - radius);
            ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
            ctx.lineTo(x + radius, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Textura acanalada (l√≠neas horizontales)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                const lineY = y + (h / 4) * (i + 1);
                ctx.beginPath();
                ctx.moveTo(x + 5, lineY);
                ctx.lineTo(x + w - 5, lineY);
                ctx.stroke();
            }

            // Indicador de nivel de agua (azul)
            const fillLevel = 0.7;
            ctx.fillStyle = 'rgba(0, 102, 204, 0.3)';
            ctx.fillRect(x + 2, y + h - (h * fillLevel) + 2, w - 4, h * fillLevel - 4);

            // Brillo
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x + w * 0.3, y + h * 0.3, 15, 0, Math.PI * 2);
            ctx.stroke();
        }

        function drawAerator(tank) {
            const x = tank.x + tank.width / 2;
            const y = tank.y - 30;

            // Motor/Soplador (c√≠rculo)
            ctx.fillStyle = '#ff8c00';
            ctx.strokeStyle = '#ffa500';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Aspa del soplador
            ctx.strokeStyle = '#ffb84d';
            ctx.lineWidth = 2;
            for (let i = 0; i < 3; i++) {
                const angle = (i * Math.PI * 2 / 3) + (state.currentTime * 0.1);
                const x1 = x + Math.cos(angle) * 8;
                const y1 = y + Math.sin(angle) * 8;
                const x2 = x - Math.cos(angle) * 8;
                const y2 = y - Math.sin(angle) * 8;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }

            // Tuber√≠as de aire (l√≠neas hacia el tanque)
            ctx.strokeStyle = 'rgba(255, 140, 0, 0.6)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x - 5, y + 12);
            ctx.lineTo(x - 5, tank.y + 10);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x + 5, y + 12);
            ctx.lineTo(x + 5, tank.y + 10);
            ctx.stroke();
        }

        function drawBubbles(tank, index) {
            const bubbleCount = 8;
            for (let i = 0; i < bubbleCount; i++) {
                const bubbleTime = (state.currentTime * 2 + i * 0.5) % 30;
                const progress = bubbleTime / 30;

                const startX = tank.x + 15 + Math.random() * (tank.width - 30);
                const startY = tank.y + tank.height - 10;
                const endY = tank.y + 10;

                const bubbleX = startX + Math.sin(progress * Math.PI * 4) * 10;
                const bubbleY = startY + (endY - startY) * progress;
                const bubbleRadius = 3 * (1 - progress * 0.5);

                ctx.fillStyle = 'rgba(100, 200, 255, ' + (1 - progress * 0.5) + ')';
                ctx.beginPath();
                ctx.arc(bubbleX, bubbleY, bubbleRadius, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'rgba(150, 220, 255, ' + (1 - progress * 0.5) + ')';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        function drawPipelines() {
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);

            // Conexiones entre tanques
            for (let i = 0; i < state.tanks.length - 1; i++) {
                const from = state.tanks[i];
                const to = state.tanks[i + 1];

                const fromX = from.x + from.width;
                const fromY = from.y + from.height / 2;
                const toX = to.x;
                const toY = to.y + to.height / 2;

                // Tuber√≠a principal
                ctx.beginPath();
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(fromX + 20, fromY);
                ctx.quadraticCurveTo(fromX + 40, (fromY + toY) / 2, toX - 20, toY);
                ctx.lineTo(toX, toY);
                ctx.stroke();

                // Puntos de conexi√≥n (acoples)
                ctx.setLineDash([]);
                ctx.fillStyle = '#ff8c00';
                ctx.beginPath();
                ctx.arc(fromX, fromY, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(toX, toY, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.setLineDash([5, 5]);
            }

            ctx.setLineDash([]);
        }

        function drawFlowIndicators() {
            // Flechas de flujo en las tuber√≠as
            ctx.fillStyle = 'rgba(0, 212, 255, 0.6)';

            for (let i = 0; i < state.tanks.length - 1; i++) {
                const from = state.tanks[i];
                const to = state.tanks[i + 1];

                const fromX = from.x + from.width;
                const fromY = from.y + from.height / 2;
                const toX = to.x;
                const toY = to.y + to.height / 2;

                // Posici√≥n de la flecha (a mitad de camino)
                const midX = (fromX + toX) / 2;
                const midY = (fromY + toY) / 2;

                // Dibujar flecha
                const arrowSize = 8;
                const angle = Math.atan2(toY - fromY, toX - fromX);

                ctx.beginPath();
                ctx.moveTo(midX, midY);
                ctx.lineTo(midX - arrowSize * Math.cos(angle - Math.PI / 6), 
                           midY - arrowSize * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(midX - arrowSize * Math.cos(angle + Math.PI / 6), 
                           midY - arrowSize * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            }
        }

        function drawLabels() {
            ctx.fillStyle = 'var(--accent-cyan)';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const labels = {
                accumulation: 'ACUMULACI√ìN',
                reactor: 'REACTOR BIO',
                clarifier: 'CLARIFICADOR'
            };

            // Agrupar tanques por tipo y etiquetar
            let lastType = null;
            let labelCount = 0;

            state.tanks.forEach((tank, index) => {
                if (tank.type !== lastType) {
                    labelCount = 0;
                }

                ctx.fillText(labels[tank.type] + (labelCount + 1), 
                            tank.x + tank.width / 2, 
                            tank.y - 15);

                lastType = tank.type;
                labelCount++;
            });

            // T√≠tulo
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = 'var(--accent-green)';
            ctx.textAlign = 'left';
            ctx.fillText('RTB' + state.plant, 20, 30);

            // Estado
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = state.isAerating ? 'var(--accent-green)' : 'var(--accent-amber)';
            ctx.textAlign = 'right';
            ctx.fillText(state.isAerating ? '‚óè AIREANDO' : '‚óè REPOSO', 
                        elements.canvas.width - 20, 30);
        }

        // ========== CONTROL DE CICLO ==========
        function startSimulation() {
            state.isRunning = true;
            state.currentTime = 0;
            state.cycleTime = 0;
            elements.startBtn.style.display = 'none';
            elements.stopBtn.style.display = 'block';
            simulate();
        }

        function stopSimulation() {
            state.isRunning = false;
            state.isAerating = false;
            elements.startBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            updateSimulation();
        }

        function resetSimulation() {
            state.isRunning = false;
            state.isAerating = false;
            state.currentTime = 0;
            state.cycleTime = 0;
            state.dbo5Output = 0;
            state.dqoOutput = 0;
            state.efficiency = 0;
            elements.startBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            updateSimulation();
        }

        function simulate() {
            if (!state.isRunning) return;

            state.currentTime += 0.05; // 50ms por frame
            state.cycleTime += 0.05;

            const totalCycle = state.timeOn + state.timeOff;
            const cycleProgress = state.cycleTime % totalCycle;

            // Cambiar estado de aireaci√≥n
            state.isAerating = cycleProgress < state.timeOn;

            // Recalcular eficiencia en tiempo real
            const efficiency = calculateRemovalEfficiency();

            // Suavizar cambios de eficiencia (filtro de primer orden)
            state.efficiency = state.efficiency * 0.9 + efficiency * 100 * 0.1;
            state.dbo5Output = state.dbo5Input * (1 - state.efficiency / 100);
            state.dqoOutput = state.dqoInput * (1 - state.efficiency / 100);

            updateUI();
            drawPlant();

            requestAnimationFrame(simulate);
        }

        // ========== EVENT LISTENERS ==========
        elements.startBtn.addEventListener('click', startSimulation);
        elements.stopBtn.addEventListener('click', stopSimulation);
        elements.resetBtn.addEventListener('click', resetSimulation);

        // ========== INICIALIZACI√ìN ==========
        updateTankConfig();
        updateSimulation();
    </script>
</body>
</html>
